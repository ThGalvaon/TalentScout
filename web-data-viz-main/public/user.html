<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Área do Usuário</title>
    <script src="../js/sessao.js"></script>
    <style>
        /* CSS */
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            height: 100vh;
        }

        .header {
            background: #333;
            color: #fff;
            padding: 1rem;
            text-align: center;
        }

        .container {
            flex: 1;
            padding: 1rem;
        }

        .filters {
            margin-bottom: 1rem;
        }

        .filters select {
            padding: 0.5rem;
            margin-right: 0.5rem;
            font-size: 1rem;
        }

        .vagas h2 {
            margin-top: 0;
        }

        .vaga {
            border: 1px solid #ddd;
            padding: 1rem;
            margin-bottom: 1rem;
            border-radius: 5px;
        }

        .vaga h3 {
            margin: 0 0 0.5rem 0;
        }

        .vaga button {
            background: #28a745;
            color: #fff;
            border: none;
            padding: 0.5rem 1rem;
            cursor: pointer;
            border-radius: 5px;
        }

        .vaga button:hover {
            background: #218838;
        }

        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .modal.hidden {
            display: none;
        }

        .modal-content {
            background: #fff;
            padding: 2rem;
            border-radius: 5px;
            text-align: center;
        }

        .modal-content button {
            margin-top: 1rem;
            padding: 0.5rem 1rem;
            cursor: pointer;
            border-radius: 5px;
            border: none;
        }

        #confirm-button {
            background: #28a745;
            color: white;
        }

        #confirm-button:hover {
            background: #218838;
        }

        #close-modal,
        #close-success-modal {
            background: #dc3545;
            color: white;
        }

        #close-modal:hover,
        #close-success-modal:hover {
            background: #c82333;
        }
    </style>
</head>

<body onload="carregarPeneira(), validarSessao()">
    <header class="header">
        <h1 id="titulo_header">Área do Usuário</h1>
    </header>
    <div class="container">
        <!-- Filtros -->
        <div class="filters">
            <select id="filter-idade">
                <option value="">Todas as idades</option>
                <option value="Sub 18">Sub 18</option>
                <option value="Sub 21">Sub 21</option>
            </select>
            <select id="filter-genero">
                <option value="">Todas os gêneros</option>
                <option value="Masculino">Masculino</option>
                <option value="Feminino">Feminino</option>
            </select>
            <select id="filter-esporte">
                <option value="">Todos os esportes</option>
                <option value="Basquete">Basquete</option>
                <option value="Futebol">Futebol</option>
                <option value="Volei">Volei</option>
            </select>
            <button onclick="aplicarFiltros()">Filtrar</button>
        </div>

        <h2>Peneiras Disponíveis</h2>
        <div id="peneiras-list">
            <!-- Lista de peneiras será gerada dinamicamente -->
        </div>
    </div>

    <!-- Modal de Detalhes -->
    <div id="modal" class="modal hidden">
        <div class="modal-content">
            <div class="modal-content">
                <h2>Detalhes da Peneira</h2>
                <p><strong>Título:</strong> <span id="modal-titulo"></span></p>
                <p><strong>Time:</strong> <span id="modal-time"></span></p>
                <p><strong>Vagas:</strong> <span id="modal-vagas"></span></p>
                <p><strong>Idade:</strong> <span id="modal-idade"></span></p>
                <p><strong>Gênero da Vaga:</strong> <span id="modal-genero"></span></p>
                <p><strong>Local:</strong> <span id="modal-local"></span></p>
                <p><strong>Data da Peneira:</strong> <span id="modal-dataPeneira"></span></p>
                <p><strong>Data Início Inscrição:</strong> <span id="modal-dataInicioInscricao"></span></p>
                <p><strong>Data Fim Inscrição:</strong> <span id="modal-dataFimInscricao"></span></p>
                <p><strong>Esporte:</strong> <span id="modal-esporte"></span></p>
            <button id="close-modal">Fechar</button>
            <button onclick="inscreverUsuario(idPeneiras, idTime)" class="confirm-button">Confirmar Inscrição</button>
        </div>
    </div>

    <div id="success-modal" class="modal hidden">
        <div class="modal-content">
            <h2>Inscrição Realizada!</h2>
            <p>Sua inscrição foi realizada com sucesso!</p>
            <button id="close-success-modal">Fechar</button>
        </div>
    </div>

    <script>
        const peneiras = []
        const valores = []

        var idPeneiras
        var idTime

        const peneirasList = document.getElementById("peneiras-list");
        const modal = document.getElementById("modal");
        const successModal = document.getElementById("success-modal");
        const closeModalButton = document.getElementById("close-modal");
        const confirmButton = document.getElementById("confirm-button");
        const closeSuccessModalButton = document.getElementById("close-success-modal");

        const tituloPeneira = document.getElementById("modal-titulo")
        const timePeneira = document.getElementById("modal-time");
        const vagasPeneira = document.getElementById("modal-vagas")
        const faixaEtaria = document.getElementById("modal-idade")
        const generoPeneira = document.getElementById("modal-genero")
        const localPeneira = document.getElementById("modal-local");
        const esportePeneira = document.getElementById("modal-esporte");
        const fimInscricao = document.getElementById("modal-dataFimInscricao");
        const inicioInscricao = document.getElementById("modal-dataInicioInscricao");
        const dataPeneira = document.getElementById("modal-dataPeneira");

        function formatDate(dateStr) {
            const [year, month, day] = dateStr.split("-");
            return `${day}/${month}/${year}`;
        }
        function carregarPeneira(){
            peneirasList.innerHTML = "";
            fetch("/peneiras/carregarPeneira", {
                  method: "GET",
                  headers: {
                    "Content-Type": "application/json",
                  }
                })
                  .then(resposta => resposta.json())
                  .then(valores => {
                    console.log(valores)
                    peneira = valores
                    if(valores.length == 0){
                        peneirasList.innerHTML = "Nenhuma Peneira Cadastrada"
                    }else
                    valores.forEach((valor) =>{
                        const vaga = document.createElement("div");
                        vaga.className = "vaga";   
                        vaga.innerHTML += `
                        <h2>${valor.titulo}</h2>
                        <p><strong>Idade:</strong> ${valor.idade}</p>
                        <p><strong>Gênero da Vaga:</strong> ${valor.genero}</p>
                        <p><strong>Esporte:</strong> ${valor.esporte}</p>
                        <p><strong>Local:</strong> ${valor.endereco}</p>
                        <p><strong>Data da Peneira:</strong> ${formatDate(valor.data_peneira)}</p>
                        <p><strong>Data do Fim da Inscrição:</strong> ${formatDate(valor.data_fim)}</p>
                        <button onclick="carregarModal(${valor.idPeneiras})">Inscrever-se</button>
                    `;
                        peneirasList.appendChild(vaga);
                    })
                  })
                  .catch(function (erro) {
                    console.error("Erro ao carras as peneiras:", erro);
                    alert("Houve um erro ao caregar as peneiras. Tente novamente mais tarde.");
                  });
        }

        function aplicarFiltros() {
            const filtroIdade = document.getElementById("filter-idade").value;
            const filtroEsporte = document.getElementById("filter-esporte").value;
            const filtroGenero = document.getElementById("filter-genero").value;

            const filtros = {
                idade: filtroIdade || null,
                esporte: filtroEsporte || null,
                genero: filtroGenero || null
            };
            console.log("Filtros selecionados:", filtros);
            peneirasList.innerHTML = "";

            fetch("/peneiras/aplicarFiltros", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                },
                body: JSON.stringify(filtros),
            })
                .then((resposta) => resposta.json())
                .then((valores) => {
                    console.log(valores);
                    if (valores.length === 0) {
                        peneirasList.innerHTML = "Nenhuma Peneira Cadastrada";
                    } else {
                        valores.forEach((valor) => {
                            const vaga = document.createElement("div");
                            vaga.className = "vaga";
                            vaga.innerHTML += `
                                <h2>${valor.titulo}</h2>
                                <p><strong>Idade:</strong> ${valor.idade}</p>
                                <p><strong>Gênero da Vaga:</strong> ${valor.genero}</p>
                                <p><strong>Esporte:</strong> ${valor.esporte}</p>
                                <p><strong>Local:</strong> ${valor.endereco}</p>
                                <p><strong>Data da Peneira:</strong> ${formatDate(valor.data_peneira)}</p>
                                <p><strong>Data do Fim da Inscrição:</strong> ${formatDate(valor.data_fim)}</p>
                                <button onclick="carregarModal(${valor.idPeneiras})">Inscrever-se</button>
                            `;
                            peneirasList.appendChild(vaga);
                        });
                    }
                })
                .catch((erro) => {
                    console.error("Erro ao aplicar os filtros:", erro);
                });
}


        function carregarModal(idPeneira) {
            console.log("ID enviado para cadastro:", idPeneira);
    fetch(`/peneiras/carregarModal/${idPeneira}`, {
        method: "GET",
        headers: {
            "Content-Type": "application/json",
      }
    })
      .then(resposta => resposta.json())
      .then(valores => {
        console.log(valores)
        peneira = valores
        valores.forEach((valor) =>{
            if (valor) {
                const valor = valores[0];
                idPeneiras = valor.idPeneiras
                idTime = valor.fkTime
                tituloPeneira.textContent = valor.titulo;
                timePeneira.textContent = valor.nome_time
                vagasPeneira.textContent  = valor.qtd_vagas
                faixaEtaria.textContent = valor.idade;
                generoPeneira.textContent = valor.genero;
                esportePeneira.textContent = valor.esporte;
                localPeneira.textContent = valor.endereco
                dataPeneira.textContent = formatDate(valor.data_peneira);
                inicioInscricao.textContent = formatDate(valor.data_inicio);
                fimInscricao.textContent = formatDate(valor.data_fim);
                modal.classList.remove("hidden");
            };
        })
      })
}

function inscreverUsuario(idPeneira, idTime) {
            const fkUsuarios = sessionStorage.getItem("ID_USUARIO");
            const fkPeneiras = idPeneiras;
            const fkTime = idTime;
            const dtInscricao = new Date().toISOString().split("T")[0];
                
            const inscricao = { fkUsuarios, fkPeneiras, fkTime, dtInscricao };
                
            fetch("/peneiras/inscrever", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                },
                body: JSON.stringify(inscricao),
            })
                .then((resposta) => resposta.json())
                .then((mensagem) => {
                    if(mensagem.erro == undefined){
                        successModal.classList.remove("hidden")
                    }else alert(mensagem.erro), modal.classList.add("hidden");
                })
                .catch((erro) => {
                    console.error("Erro ao realizar inscrição:", erro);
                });
}

        if(closeModalButton){closeModalButton.addEventListener("click", () => {
            modal.classList.add("hidden");
        });}
        
        if(confirmButton){confirmButton.addEventListener("click", () => {
            modal.classList.add("hidden");
            successModal.classList.remove("hidden");
        });}
        

        closeSuccessModalButton.addEventListener("click", () => {
            successModal.classList.add("hidden");
        });
    </script>
</body>

</html>
